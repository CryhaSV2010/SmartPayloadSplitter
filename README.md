# Smart Payload Splitter

Инструмент для исследования атак обхода IDS/IPS путём фрагментации пейлоадов и их динамической сборки на стороне сервера.

## Описание

**Smart Payload Splitter** — это исследовательский инструмент, демонстрирующий технику обхода IDS/IPS через фрагментацию вредоносных пейлоадов. Пейлоад разбивается на фрагменты случайной длины, которые отправляются в произвольном порядке и собираются на стороне сервера с помощью JavaScript.

### Классификация по MITRE ATT&CK

- **T1027** - Obfuscated Files or Information
- **T1132** - Data Encoding  
- **T1048** - Exfiltration using an alternative protocol

### Архитектура

Проект состоит из трёх основных компонентов:

1. **Клиентская часть** (`client/payload_fragmenter.py`) — Python-скрипт для фрагментации и отправки пейлоада
2. **Серверная часть** (`server/server.py`) — Flask-сервер для приёма фрагментов
3. **Веб-интерфейс** — JavaScript-сборщик фрагментов в браузере

### Принцип работы

1. **Фрагментация**: Пейлоад разбивается на фрагменты случайной длины (в диапазоне min-max)
2. **Перемешивание**: Фрагменты перемешиваются в случайном порядке
3. **Отправка**: Фрагменты отправляются на сервер с задержкой между запросами
4. **Хранение**: Сервер сохраняет фрагменты в памяти, ассоциируя их с session_id
5. **Сборка**: По команде фрагменты собираются в правильном порядке
6. **Выполнение**: Собранный пейлоад готов к выполнению (в демо-версии только отображается)

## Установка

### Системные требования

- **Операционная система**: Windows 7/10/11
- **Python**: версия 3.8 или выше
- **Пакетный менеджер**: pip

### Локальная установка

#### Установка зависимостей

```bash
pip install -r requirements.txt
```

#### Проверка установки

```bash
python -c "import flask, flask_cors, requests; print('Все зависимости установлены успешно!')"
```

## Быстрый старт

### Запуск сервера (локально)

Два раза левой кнопкой мыши по `run_server.bat`


Сервер будет доступен по адресу `http://localhost:5000`

### Мониторинг через веб-интерфейс

Откройте в браузере:
- `http://localhost:5000` — главная страница
- `http://localhost:5000/session/<session_id>` — страница для конкретной сессии

---

## Использование клиента

### Базовое использование

```bash
python client/payload_fragmenter.py путь_к_файлу.txt -u http://localhost:5000
```

### Параметры командной строки

#### Обязательные параметры

- `payload` — путь к файлу с пейлоадом (позиционный аргумент)
- `-u, --url` — URL целевого сервера (обязательный параметр)

#### Опциональные параметры

- `-min, --min-size N` — минимальный размер фрагмента в байтах (по умолчанию: 10)
- `-max, --max-size N` — максимальный размер фрагмента в байтах (по умолчанию: 100)
- `-d, --delay F` — задержка между отправками фрагментов в секундах (по умолчанию: 0.1)
- `-r, --report PATH` — путь для сохранения отчёта (по умолчанию: `report_<session_id>.txt`)
- `--no-shuffle` — не перемешивать фрагменты, отправить в исходном порядке
- `--assemble` — автоматически отправить команду на сборку пейлоада после отправки всех фрагментов

### Генерация отчётов

После выполнения клиент автоматически генерирует отчёт, содержащий:

- Общую информацию о сессии
- Статистику отправки фрагментов
- Временные характеристики
- Детальную информацию о каждом фрагменте

Отчёт сохраняется в файл `report_<session_id>.txt` или в указанный файл через параметр `-r`.

---


## Тестирование обхода IDS

### Способ 1: Маленькие фрагменты (5-20 байт)

```bash
python client/payload_fragmenter.py test_payload.txt -u http://localhost:5000 --min-size 5 --max-size 20 -d 0.1 --assemble
```

**Ожидаемый результат:** Пейлоад разбит на много маленьких фрагментов, Suricata НЕ должна обнаружить полный пейлоад.

### Способ 2: Большие фрагменты (100-500 байт)

```bash
python client/payload_fragmenter.py test_payload.txt -u http://localhost:5000 --min-size 100 --max-size 500 -d 0.2 --assemble
```

### Способ 3: Без перемешивания

```bash
python client/payload_fragmenter.py test_payload.txt -u http://localhost:5000 --min-size 10 --max-size 50 --no-shuffle -d 0.15 --assemble
```

### Способ 4: Медленная отправка (2 сек задержка)

```bash
python client/payload_fragmenter.py test_payload.txt -u http://localhost:5000 --min-size 15 --max-size 100 -d 2.0 --assemble
```

### Способ 5: Быстрая отправка (0.01 сек)

```bash
python client/payload_fragmenter.py test_payload.txt -u http://localhost:5000 --min-size 10 --max-size 50 -d 0.01 --assemble
```

### Способ 6: Комбинированный подход

```bash
python client/payload_fragmenter.py test_payload.txt -u http://localhost:5000 --min-size 8 --max-size 30 -d 0.5 --assemble
```

## API сервера

### POST /api/fragment

Приём фрагмента от клиента.

**Запрос:**
```json
{
    "session_id": "session_1234567890_1234",
    "fragment_index": 0,
    "total_fragments": 10,
    "data": "base64_encoded_fragment_data"
}
```

**Ответ:**
```json
{
    "status": "success",
    "message": "Фрагмент 0 получен",
    "received_fragments": 1,
    "total_fragments": 10
}
```

### GET /api/fragments/<session_id>

Получение информации о фрагментах для сессии.

**Ответ:**
```json
{
    "status": "success",
    "fragments": {
        "0": true,
        "1": true,
        "2": false
    },
    "total_fragments": 10,
    "received_count": 2
}
```

### POST /api/assemble

Сборка пейлоада из фрагментов.

**Запрос:**
```json
{
    "session_id": "session_1234567890_1234"
}
```

**Ответ:**
```json
{
    "status": "success",
    "message": "Пейлоад успешно собран",
    "payload_size": 1024,
    "payload": "First 1000 characters of assembled payload...",
    "assembled_at": "2024-01-15T10:30:00"
}
```

### GET /api/stats

Получение статистики сервера.

**Ответ:**
```json
{
    "active_sessions": 2,
    "total_fragments_stored": 25,
    "sessions": {
        "session_1234567890_1234": {
            "fragments_count": 10,
            "total_fragments": 10,
            "created_at": "2024-01-15T10:00:00",
            "last_update": "2024-01-15T10:05:00"
        }
    }
}
```

---

## Известные ограничения

- В демо-версии пейлоад не выполняется, только собирается
- Веб-интерфейс работает только для одной сессии за раз

## Возможные улучшения

- Поддержка множественных сессий в веб-интерфейсе
- Интеграция с популярными IDS/IPS для автоматического тестирования

---

## Литература и ссылки

- [MITRE ATT&CK Framework](https://attack.mitre.org/)

---
